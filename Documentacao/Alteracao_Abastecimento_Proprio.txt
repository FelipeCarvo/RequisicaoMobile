PEND√äNCIAS - ABASTECIMENTO PR√ìPRIO (APP)

Data √öltima Atualiza√ß√£o: 25/12/2025 - 11:30
Status: Funcionalidade parcialmente implementada

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è LIMITA√á√ÉO CR√çTICA DO BACKEND ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

PROBLEMA: Registros salvos com destino Bomba/Comboio/Devolu√ß√£o N√ÉO aparecem na listagem!

CAUSA RAIZ:
  1. Backend rejeita IdEquipamento quando destino n√£o √© tipo "M" (Equipamento)
     ‚Üí Erro 500: "Equipamento n√£o pode ser informado para esse destino"

  2. Consulta ConsultaAbastecimento s√≥ retorna registros que T√äM equipamentoId
     ‚Üí Registros sem equipamento s√£o ignorados pela query

RESULTADO:
  ‚úÖ Registro salva com sucesso (retorna GUID)
  ‚ùå Registro NUNCA aparece nas consultas

EVID√äNCIA (25/12/2025):
  - Salvamos registro com destino "01 - BOMBA 001" (tipo B)
  - GUID retornado: 1cfa622c-2d9a-438d-8965-172b6609bc11
  - Listagem continua mostrando apenas 2 registros antigos
  - Novo registro existe no banco, mas consulta n√£o retorna

SOLU√á√ÉO TEMPOR√ÅRIA:
  ‚Üí Sempre use destino tipo "M" (Equipamento) para registros aparecerem na listagem

SOLU√á√ÉO DEFINITIVA (REQUER BACKEND):
  Op√ß√£o A: Backend aceitar IdEquipamento para TODOS os tipos de destino
  Op√ß√£o B: Consulta retornar registros SEM equipamentoId tamb√©m

====================================================================
‚úÖ O QUE J√Å FOI IMPLEMENTADO HOJE (25/12/2025)
====================================================================

1. ‚úÖ Campo Etapa voltou a ficar sempre habilitado (removido [disabled])
   - Removido helper text "Selecione Empreendimento e Insumo primeiro"
   - Comportamento default restaurado

2. ‚úÖ Coment√°rio cr√≠tico adicionado no m√©todo confirmar()
   - Documenta limita√ß√£o do backend
   - Orienta desenvolvedores futuros

====================================================================
‚úÖ O QUE J√Å FOI IMPLEMENTADO (24/12/2025)
====================================================================

1. ‚úÖ CSP (Content Security Policy) configurado no index.html
2. ‚úÖ Interface AbastecimentoConsulta corrigida (camelCase)
3. ‚úÖ Tela de listagem funcionando corretamente
4. ‚úÖ Exibi√ß√£o de dados nos cards (equipamento, data, quantidade, etc)
5. ‚úÖ Navega√ß√£o "Ver Detalhes" implementada (passa dados via state)
6. ‚úÖ Tela de edi√ß√£o recebe dados no construtor
7. ‚úÖ Formul√°rio preenche campos principais automaticamente:
   - Data, Bomba, Equipamento, Bico, Insumo, Quantidade, Od√¥metro, Hor√≠metro
8. ‚úÖ Carregamento de listas dependentes (bicos, destinos, insumos, etc)
9. ‚úÖ Filtro "Origem: 3" removido para buscar todos os abastecimentos pr√≥prios


====================================================================
‚ùå LIMITA√á√ÉO CONHECIDA: API N√ÉO RETORNA TODOS OS CAMPOS
====================================================================

**IMPORTANTE:** A API `/api/frotas/Abastecimentos/ConsultaAbastecimento` √© para
LISTAGEM, n√£o para edi√ß√£o completa. N√£o existe endpoint para buscar detalhes
completos de um abastecimento (confirmado via Swagger).

**Campos que N√ÉO retornam na API de listagem:**
- Destino (destinoId)
- Empreendimento (s√≥ retorna c√≥digo emprdCod, n√£o o ID)
- Etapa (etapaId)
- Bloco (blocoId)
- N√∫meros da bomba (numBombaInicial/Final)
- Hora do abastecimento
- Motorista/Operador (responsavelId vem zerado)
- Colaborador/Frentista
- Aplica√ß√£o (aplicacaoId)
- Troca/Reposi√ß√£o (tipoPrevAbast)

**Consequ√™ncia:** Ao clicar "Ver Detalhes", apenas campos b√°sicos s√£o preenchidos.
Os demais ficam vazios para o usu√°rio preencher se desejar atualizar.


====================================================================
üîß PEND√äNCIAS CR√çTICAS (IMPEDEM USO CORRETO)
====================================================================

[ ] 1. CAMPOS N√ÉO ENVIADOS NO PAYLOAD
    Problema: Campos existem na UI, usu√°rio seleciona, mas n√£o s√£o salvos

    Campos afetados:
    - TipoPrevAbast (Troca/Reposi√ß√£o)
    - AplicacaoPrevId (Aplica√ß√£o)
    - IdEtapa (Etapa)
    - IdTanqueDestino (quando destino n√£o √© equipamento)

    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()

    A√ß√£o: Adicionar esses campos ao objeto params antes de enviar

[ ] 2. VALIDA√á√ïES INCOMPLETAS
    Problema: Campos obrigat√≥rios n√£o s√£o validados antes de enviar

    Faltam valida√ß√µes para:
    - Bico (obrigat√≥rio)
    - Destino (obrigat√≥rio)
    - Insumo (obrigat√≥rio)

    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()

    A√ß√£o: Adicionar valida√ß√µes com mensagens de erro espec√≠ficas

[ ] 3. CAMPOS NA UI SEM CONEX√ÉO
    Problema: Campos aparecem mas n√£o fazem nada

    Campos afetados:
    - Od√¥metro Atual (existe mas n√£o tem ngModel)
    - Hor√≠metro Atual (existe mas n√£o tem ngModel)
    - Hora Abastecimento (input time n√£o conectado)

    Decis√£o necess√°ria:
    - OP√á√ÉO A: Conectar ao formul√°rio e enviar no payload (descobrir nomes no backend)
    - OP√á√ÉO B: Remover da UI se n√£o s√£o necess√°rios

    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.html
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts


====================================================================
‚ö†Ô∏è PEND√äNCIAS IMPORTANTES (PODEM CAUSAR PROBLEMAS)
====================================================================

[ ] 4. IMPLEMENTAR IdTanqueDestino
    Problema: Doc exige esse campo quando destino N√ÉO √© equipamento

    L√≥gica necess√°ria:
    - Se destinoTipo <> 'M' (n√£o √© equipamento)
    - Ent√£o enviar IdTanqueDestino = destinoSelecionado

    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()

[ ] 5. REVISAR L√ìGICA DE IdEquipamento
    Problema: Atualmente s√≥ envia quando destino √© equipamento

    Quest√£o: Backend precisa IdEquipamento SEMPRE ou s√≥ quando destino='M'?

    A√ß√£o: Verificar com backend e ajustar se necess√°rio

    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()


====================================================================
üìã MELHORIAS RECOMENDADAS (N√ÉO BLOQUEIAM)
====================================================================

[ ] 6. IMPLEMENTAR ConsultaUltimoNumeroBico
    Benef√≠cio: Auto-preencher No.Bomba Inicial (melhora UX)

    Passos:
    1. Criar m√©todo no servi√ßo:
       consultarUltimoNumeroBico(bombaId, bicoId)
       -> GET /api/frotas/Abastecimentos/ConsultaUltimoNumeroBico

    2. Chamar quando bomba+bico forem selecionados

    3. Auto-preencher this.numBombaInicial com resultado+1

    Arquivos:
    - src/app/services/abastecimento.service.ts
    - src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts

[ ] 7. MELHORAR EXPERI√äNCIA DO USU√ÅRIO
    - Adicionar loading spinners durante carregamento
    - Desabilitar bot√£o CONFIRMAR durante grava√ß√£o
    - Melhorar mensagens de erro (mais espec√≠ficas)
    - Adicionar confirma√ß√£o ao sair com dados n√£o salvos

[ ] 8. CRIAR ENDPOINT NO BACKEND (OPCIONAL)
    Benef√≠cio: Permitir edi√ß√£o completa com todos os campos

    Endpoint sugerido:
    GET /api/frotas/Abastecimentos/BuscarPorId/{abastecimentoId}

    Deve retornar TODOS os campos salvos, incluindo:
    - destinoId, empreendimentoId, etapaId, blocoId
    - numBombaInicial, numBombaFinal
    - responsavelId (v√°lido), colaboradorId
    - aplicacaoId, tipoPrevAbast
    - hora do abastecimento (se existe)

    Atualiza√ß√£o necess√°ria no app:
    - Criar m√©todo obterAbastecimentoPorId() no servi√ßo
    - Usar este m√©todo em vez de passar dados via state


====================================================================
üìä RESUMO DO STATUS
====================================================================

FUNCIONAL HOJE:
‚úÖ Novo abastecimento (cadastro) - 90% funcional
‚úÖ Pesquisa com filtros - 100% funcional
‚úÖ Listagem de resultados - 100% funcional
‚úÖ Navega√ß√£o entre telas - 100% funcional
‚úÖ Ver detalhes (parcial) - mostra campos b√°sicos

N√ÉO FUNCIONAL:
‚ùå Salvar Troca/Reposi√ß√£o e Aplica√ß√£o (n√£o envia no payload)
‚ùå Salvar Etapa (n√£o envia no payload)
‚ùå Edi√ß√£o completa (faltam muitos campos na API de listagem)
‚ùå Valida√ß√µes de campos obrigat√≥rios

RISCO ATUAL:
- Usu√°rio pode gravar sem Bico/Destino/Insumo (campos obrigat√≥rios)
- Usu√°rio seleciona Aplica√ß√£o/Etapa mas dados n√£o s√£o salvos
- Campos "Atual" e "Hora" aparecem mas n√£o funcionam


====================================================================
üéØ PRIORIDADES SUGERIDAS
====================================================================

**FASE 1 - URGENTE (2-3 horas)**
1. Adicionar TipoPrevAbast, AplicacaoPrevId, IdEtapa ao payload
2. Implementar IdTanqueDestino
3. Adicionar valida√ß√µes de campos obrigat√≥rios

**FASE 2 - IMPORTANTE (1-2 horas)**
4. Decidir sobre campos "Atual" e "Hora" (conectar ou remover)
5. Revisar l√≥gica de IdEquipamento

**FASE 3 - MELHORIAS (opcional)**
6. Implementar ConsultaUltimoNumeroBico
7. Melhorar UX geral
8. Solicitar endpoint de busca completa ao backend


====================================================================
FIM DO DOCUMENTO DE PEND√äNCIAS
====================================================================

√öltima atualiza√ß√£o: 24/12/2025 - 22:40
Respons√°vel: An√°lise ap√≥s implementa√ß√£o parcial



Fontes analisadas:
- Documenta√ß√£o: Documentacao/Frt_ApiFrotas.md
  - 1.10 Pesquisa Abastecimento Pr√≥prio
  - 1.11 Gravar Abastecimento Pr√≥prio
- C√≥digo (tela filtros): src/app/page/abastecimento-proprio/abastecimento-proprio.page.html
- C√≥digo (tela filtros - l√≥gica): src/app/page/abastecimento-proprio/abastecimento-proprio.page.ts
- C√≥digo (listagem): src/app/page/abastecimento-proprio-pesquisa/abastecimento-proprio-pesquisa.page.html
- C√≥digo (listagem - l√≥gica): src/app/page/abastecimento-proprio-pesquisa/abastecimento-proprio-pesquisa.page.ts
- C√≥digo (edi√ß√£o/cadastro): src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.html
- C√≥digo (edi√ß√£o/cadastro - l√≥gica): src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
- Servi√ßo: src/app/services/abastecimento.service.ts


====================================================================
VIS√ÉO GERAL - ESTRUTURA IMPLEMENTADA
====================================================================

A funcionalidade de Abastecimento Pr√≥prio possui 3 telas principais:

1) TELA DE FILTROS (abastecimento-proprio.page)
   - Permite filtrar por: Origem/Tanque, Equipamento, Data Inicial, Data Final
   - Possui bot√£o "NOVO" (navega para tela de edi√ß√£o)
   - Possui bot√£o "PESQUISAR" (navega para tela de listagem com filtros)

2) TELA DE LISTAGEM/RESULTADOS (abastecimento-proprio-pesquisa.page)
   - Exibe cards com resultados da pesquisa
   - Cada card mostra: Equipamento, Placa, Data, Quantidade, Insumo, Fornecedor, Voucher
   - Bot√£o "VER DETALHES" em cada card (navega para tela de edi√ß√£o)

3) TELA DE EDI√á√ÉO/CADASTRO (abastecimento-proprio-edicao.page)
   - Formul√°rio completo com todos os campos
   - Integra√ß√£o com m√∫ltiplas APIs para carregar combos
   - Bot√£o "CONFIRMAR" que grava os dados

STATUS GERAL: Estrutura b√°sica implementada (~70-80%), mas com pend√™ncias importantes.


====================================================================
PARTE 1 - AN√ÅLISE DA TELA DE FILTROS (PESQUISA)
====================================================================

Documenta√ß√£o (1.10) vs Implementa√ß√£o Atual:

| Campo Documenta√ß√£o          | Campo na UI        | Implementado? | Status |
|-----------------------------|--------------------|---------------|--------|
| Origem/Tanque (ConsultaBomba) | Origem / Tanque  | SIM           | OK     |
| Equipamento (EquipamentosMobile) | Equipamento   | SIM           | OK     |
| -                           | Data Inicial       | SIM           | EXTRA* |
| -                           | Data Final         | SIM           | EXTRA* |

* EXTRA: A documenta√ß√£o n√£o menciona filtros de data, mas est√£o implementados e s√£o √∫teis.

FUNCIONALIDADE:
‚úÖ Campos de filtro funcionando
‚úÖ Navega√ß√£o para tela de listagem com queryParams
‚úÖ Bot√£o "NOVO" funcionando
‚úÖ Integra√ß√£o com API: consultarAbastecimentoProprio()

OBSERVA√á√ïES:
- Filtros de data s√£o extras mas √∫teis (n√£o causam problema)
- A UI permite pesquisar sem preencher nenhum filtro (retorna todos)


====================================================================
PARTE 2 - AN√ÅLISE DA TELA DE LISTAGEM (RESULTADOS)
====================================================================

CAMPOS EXIBIDOS NOS CARDS:
‚úÖ Equipamento (codequipamento + modelo)
‚úÖ Placa
‚úÖ Data do abastecimento
‚úÖ Quantidade
‚úÖ Insumo
‚úÖ Fornecedor/Posto (fornecedorRazao)
‚úÖ Voucher (numVoucher) - se existir

FUNCIONALIDADE:
‚úÖ Recebe filtros via queryParams
‚úÖ Chama API consultarAbastecimentoProprio() com TpAbastecimento=0 e Origem=3
‚úÖ Exibe mensagem quando n√£o h√° resultados
‚úÖ Bot√£o "VER DETALHES" em cada card

OBSERVA√á√ïES:
- O campo "Fornecedor/Posto" aparece nos cards, mas para abastecimento pr√≥prio normalmente n√£o h√° fornecedor externo (pode ser o frentista ou ficar vazio)
- A listagem est√° funcional e correta


====================================================================
PARTE 3 - AN√ÅLISE DA TELA DE EDI√á√ÉO/CADASTRO (PRINCIPAL)
====================================================================

IMPORTANTE: Esta tela se chama "Abastecimento Pr√≥prio - Edi√ß√£o" mas atualmente funciona APENAS como CADASTRO NOVO.

===========================
3.1. CAMPOS IMPLEMENTADOS
===========================

Tabela (Documenta√ß√£o 1.11 -> Implementa√ß√£o):

| Campo Doc (N¬∫)              | Campo UI                    | ngModel conectado? | Carrega API? | Envia Payload? | Status |
|-----------------------------|-----------------------------|--------------------|--------------|----------------|--------|
| 1 - Origem/Tanque           | Origem / Tanque             | SIM (bombaSelecionada) | SIM (ConsultaBomba) | SIM (IdTanqueOrigem) | OK |
| 2 - Equipamento             | Equipamento                 | SIM (equipamentoSelecionado) | SIM (EquipamentosMobile) | PARCIAL* | OK* |
| 3 - Bico                    | Bomba / Bico                | SIM (bicoSelecionado) | SIM (ConsultaBico) | SIM (IdBico) | OK |
| 4 - Destino                 | Destino                     | SIM (destinoSelecionado) | SIM (ConsultaDestinoAbastecimentos) | SIM (TpDestino) | OK |
| 5 - Empreendimento          | Empreendimento              | SIM (empreendimentoSelecionado) | SIM (Empreendimentos) | SIM (IdEmprd) | OK |
| 6 - Etapa                   | Etapa                       | SIM (etapaSelecionada) | SIM (Etapas) | N√ÉO** | FALTA |
| 7 - Insumo                  | Insumo                      | SIM (insumoSelecionado) | SIM (ConsultaEstoqueComboio) | SIM (IdInsumo) | OK |
| 8 - BombaInicial            | No.Bomba Inicial            | SIM (numBombaInicial) | N√ÉO*** | SIM (NumBicoInicial) | PARCIAL |
| 9 - Motorista/Operador      | Motorista / Operador        | SIM (motoristaOperadorSelecionado) | SIM (ConsultaColaborador Classif=1) | SIM (OperadorSolicitanteId) | OK |
| 10 - Colaborador Frentista  | Colaborador / Frentista     | SIM (colaboradorFrentistaSelecionado) | SIM (Pessoas Funcion√°rio) | SIM (FrentistaId) | OK |
| 11 - Bloco                  | Bloco                       | SIM (blocoSelecionado) | SIM (Unidades/Blocos) | SIM (IdBloco) | OK |
| NOVO - Aplica√ß√£o            | Aplica√ß√£o                   | SIM (aplicacaoSelecionada) | SIM (ConsultaAplicacaoPrevEquipInsumo) | N√ÉO | FALTA |
| NOVO - Troca/Reposi√ß√£o      | Troca/ Reposi√ß√£o            | SIM (tipoPrevAbast) | N√ÉO (combo fixo T/R) | N√ÉO | FALTA |
| 12 - Data                   | Data do abastecimento       | SIM (data) | N√ÉO (calend√°rio) | SIM (DataAbastecimento) | OK |
| - Od√¥metro                  | Od√¥metro Abastecimento      | SIM (odometro) | N√ÉO | SIM (Odometro) | OK |
| - Od√¥metro                  | Od√¥metro Atual              | N√ÉO | N√ÉO | N√ÉO | PROBLEMA |
| - Hor√≠metro                 | Hor√≠metro                   | SIM (horimetro) | N√ÉO | SIM (Horimetro) | OK |
| - Hor√≠metro                 | Hor√≠metro Atual             | N√ÉO | N√ÉO | N√ÉO | PROBLEMA |
| 19 - Quantidade             | Quantidade                  | SIM (quantidade) | N√ÉO | SIM (QtdInsumo) | OK |
| 20 - No.Bomba Final         | No.Bomba Final              | SIM (numBombaFinal) | N√ÉO | SIM (NumBicoFinal) | OK |
| - Hora                      | Hora Abastecimento          | N√ÉO | N√ÉO | N√ÉO | FALTA |
| - Observa√ß√£o                | Observa√ß√£o                  | SIM (observacao) | N√ÉO | SIM (Observacao) | OK |

LEGENDA:
* PARCIAL (Equipamento): IdEquipamento s√≥ √© enviado quando destinoTipo='M', mas doc sugere que pode ser necess√°rio sempre
** FALTA (Etapa): Campo existe, est√° conectado, mas N√ÉO est√° sendo enviado no payload (n√£o h√° IdEtapa no payload)
*** PARCIAL (BombaInicial): Doc recomenda consultar ConsultaUltimoNumeroBico para auto-preencher, mas n√£o foi implementado

===========================
3.2. CAMPOS FIXOS (N√ÉO VIS√çVEIS AO USU√ÅRIO)
===========================

No payload de grava√ß√£o, s√£o enviados valores fixos:

‚úÖ TpAbastecimento = 0 (identifica como abastecimento pr√≥prio)
‚úÖ Origem = 3 (identifica que √© do app mobile)

Estes campos est√£o corretos conforme a documenta√ß√£o.

===========================
3.3. PAR√ÇMETROS OBRIGAT√ìRIOS (DOC 1.11) vs PAYLOAD ATUAL
===========================

Documenta√ß√£o diz que s√£o OBRIGAT√ìRIOS:

| Par√¢metro         | Enviado? | Validado? | Observa√ß√£o |
|-------------------|----------|-----------|------------|
| TpAbastecimento   | SIM (0)  | N√ÉO       | Fixo no c√≥digo |
| DataAbastecimento | SIM      | SIM       | Toast de erro se vazio |
| TpDestino         | SIM      | N√ÉO       | N√£o valida se foi selecionado |
| IdTanqueOrigem    | SIM      | SIM       | Validado como "Origem/Tanque obrigat√≥ria" |
| IdBico            | SIM      | N√ÉO       | N√£o valida se foi selecionado |
| IdEquipamento     | PARCIAL* | SIM       | S√≥ quando destinoTipo='M' |
| IdInsumo          | SIM      | N√ÉO       | N√£o valida se foi selecionado |
| QtdInsumo         | SIM      | SIM       | Validado se > 0 |
| Origem            | SIM (3)  | N√ÉO       | Fixo no c√≥digo |

* IdEquipamento: A l√≥gica atual s√≥ envia quando destino exige (destinoTipo='M'), mas isso pode estar incorreto.

PROBLEMA: V√°rios campos obrigat√≥rios n√£o s√£o validados antes de enviar.

===========================
3.4. PAR√ÇMETROS N√ÉO OBRIGAT√ìRIOS vs PAYLOAD ATUAL
===========================

| Par√¢metro Doc         | Enviado?  | Implementado na UI? |
|-----------------------|-----------|---------------------|
| Horimetro             | SIM       | SIM                 |
| Odometro              | SIM       | SIM                 |
| OperadorSolicitanteId | SIM       | SIM                 |
| NumBicoInicial        | SIM       | SIM                 |
| NumBicoFinal          | SIM       | SIM                 |
| IdEmprd               | SIM       | SIM                 |
| TipoPrevAbast         | N√ÉO ‚ùå    | SIM (mas n√£o envia) |
| AplicacaoPrevId       | N√ÉO ‚ùå    | SIM (mas n√£o envia) |
| IdTanqueDestino       | N√ÉO ‚ùå    | N√ÉO                 |
| Observacao            | SIM       | SIM                 |
| FrentistaId           | SIM       | SIM                 |
| IdBloco               | SIM       | SIM                 |

PROBLEMAS CR√çTICOS:
‚ùå TipoPrevAbast: Campo existe na UI (Troca/Reposi√ß√£o), usu√°rio pode selecionar, mas N√ÉO √© enviado no payload
‚ùå AplicacaoPrevId: Campo existe na UI (Aplica√ß√£o), usu√°rio pode selecionar, mas N√ÉO √© enviado no payload
‚ùå IdTanqueDestino: Doc diz que deve ser informado quando destinoTipo<>"M", mas n√£o est√° implementado
‚ùå IdEtapa: Campo existe na UI, est√° funcionando, mas N√ÉO √© enviado no payload

===========================
3.5. CAMPOS DA UI QUE N√ÉO EST√ÉO NA DOCUMENTA√á√ÉO
===========================

| Campo UI              | Conectado? | Observa√ß√£o |
|-----------------------|------------|------------|
| Od√¥metro Atual        | N√ÉO        | Existe visualmente mas n√£o tem ngModel nem vai pro payload |
| Hor√≠metro Atual       | N√ÉO        | Existe visualmente mas n√£o tem ngModel nem vai pro payload |
| Hora Abastecimento    | N√ÉO        | Campo tipo "time" existe mas n√£o est√° conectado |

RECOMENDA√á√ÉO:
- Se "Od√¥metro Atual" e "Hor√≠metro Atual" n√£o s√£o necess√°rios, REMOVER da UI
- Se s√£o necess√°rios, CONECTAR ao payload (mas documentar qual o nome do par√¢metro no backend)
- "Hora Abastecimento": verificar se deve ser enviado separado ou j√° est√° na DataAbastecimento


====================================================================
PARTE 4 - PROBLEMA CR√çTICO: TELA DIZ "EDI√á√ÉO" MAS N√ÉO EDITA
====================================================================

SITUA√á√ÉO ATUAL:
- A p√°gina se chama "Abastecimento Pr√≥prio - Edi√ß√£o"
- Existe rota configurada: '/tabs/abastecimento-proprio-edicao'
- Na listagem, ao clicar "VER DETALHES", passa abastecimentoId via queryParams
- MAS o componente de edi√ß√£o N√ÉO:
  ‚ùå N√£o l√™ o par√¢metro abastecimentoId da rota
  ‚ùå N√£o busca os dados existentes na API
  ‚ùå N√£o preenche o formul√°rio com valores salvos
  ‚ùå N√£o diferencia entre "novo" e "edi√ß√£o"

RESULTADO:
- Ao clicar "VER DETALHES" de um abastecimento existente, abre formul√°rio vazio
- Funciona APENAS como NOVO cadastro
- N√£o h√° como editar um abastecimento j√° gravado

O QUE PRECISA SER FEITO:
1. No ngOnInit(), verificar se h√° abastecimentoId nos queryParams ou route state
2. Se houver ID, buscar os dados na API (talvez precise criar m√©todo espec√≠fico: consultarAbastecimentoProprioPorId)
3. Preencher todos os campos do formul√°rio com os valores retornados
4. Ao gravar, verificar se √© edi√ß√£o (tem ID) ou novo
5. Se edi√ß√£o, talvez precise enviar o ID no payload (verificar com backend se √© PUT ou POST com ID)


====================================================================
PARTE 5 - INTEGRA√á√ÉO COM APIs (O QUE EST√Å FUNCIONANDO)
====================================================================

O servi√ßo abastecimento.service.ts possui as seguintes integra√ß√µes:

‚úÖ listarBombas()
   -> GET /api/frotas/Abastecimentos/ConsultaBomba

‚úÖ listarBicos(bombaId)
   -> GET /api/frotas/Abastecimentos/ConsultaBico
   -> Par√¢metro: Id (bombaId)

‚úÖ listarDestinos(bombaId)
   -> GET /api/frotas/Abastecimentos/ConsultaDestinoAbastecimentos
   -> Par√¢metro: bombaId

‚úÖ listarEquipamentosMobile()
   -> POST /api/frotas/Lookups/EquipamentosMobile

‚úÖ listarEquipamentos()
   -> POST /api/frotas/Lookups/Equipamentos

‚úÖ listarInsumosComboio(bombaId)
   -> GET /api/frotas/Abastecimentos/ConsultaEstoqueComboio
   -> Par√¢metro: bombaId

‚úÖ consultarAplicacaoPrevEquipInsumo(equipamentoId, insumoId)
   -> GET /api/frotas/Abastecimentos/ConsultaAplicacaoPrevEquipInsumo
   -> Par√¢metros: equipamentoId, insumoId

‚úÖ listarEmpreendimentos()
   -> POST /api/cadastros/Lookups/Empreendimentos

‚úÖ listarColaboradoresMotoristaOperador()
   -> GET /api/frotas/OrdensServico/ConsultaColaborador
   -> Par√¢metro: Classificacao=1

‚úÖ listarColaboradoresFrentista()
   -> POST /api/cadastros/Lookups/Pessoas
   -> Body: { tipoPessoa: 'Funcion√°rio' }

‚úÖ listarBlocosPorEmpreendimento(empreendimentoId)
   -> POST /api/cadastros/Lookups/Blocos
   -> Body: { empreendimentoId }

‚úÖ consultarAbastecimentoProprio(filtros)
   -> GET /api/frotas/Abastecimentos/ConsultaAbastecimento
   -> Par√¢metros: TpAbastecimento=0, Origem=3, + filtros

‚úÖ gravarAbastecimento(payload)
   -> POST /api/frotas/Abastecimentos/GravaAbastecimento
   -> Body: payload completo

‚ùå N√ÉO IMPLEMENTADO: ConsultaUltimoNumeroBico
   -> Recomendado pela doc (item 8) para preencher No.Bomba Inicial automaticamente


====================================================================
PARTE 6 - L√ìGICA DE DEPEND√äNCIAS ENTRE CAMPOS
====================================================================

O formul√°rio possui l√≥gicas de depend√™ncia bem implementadas:

‚úÖ BOMBA -> Carrega: Bicos, Destinos, Insumos, Empreendimento (filtrado)
‚úÖ EMPREENDIMENTO -> Carrega: Blocos, habilita carregar Etapas
‚úÖ INSUMO + EMPREENDIMENTO -> Carrega: Etapas
‚úÖ EQUIPAMENTO + INSUMO -> Carrega: Aplica√ß√µes (e habilita Troca/Reposi√ß√£o e Aplica√ß√£o)
‚úÖ DESTINO tipo 'M' -> Torna Equipamento obrigat√≥rio na valida√ß√£o

OBSERVA√á√ÉO:
A l√≥gica est√° bem estruturada, apenas faltam alguns campos no payload final.


====================================================================
PARTE 7 - RESUMO DOS PROBLEMAS ENCONTRADOS
====================================================================

PRIORIDADE CR√çTICA (Impede uso correto):

1. ‚ùå TELA N√ÉO EDITA
   - Componente n√£o carrega dados existentes
   - Sempre funciona como "novo"
   - Ao clicar "VER DETALHES" na listagem, abre formul√°rio vazio

2. ‚ùå CAMPOS SELECIONADOS MAS N√ÉO ENVIADOS NO PAYLOAD
   - TipoPrevAbast (Troca/Reposi√ß√£o): campo existe, usu√°rio seleciona, mas n√£o √© enviado
   - AplicacaoPrevId (Aplica√ß√£o): campo existe, usu√°rio seleciona, mas n√£o √© enviado
   - IdEtapa (Etapa): campo existe, usu√°rio seleciona, mas n√£o √© enviado

3. ‚ùå CAMPO DOCUMENTADO MAS N√ÉO IMPLEMENTADO
   - IdTanqueDestino: doc diz para enviar quando destinoTipo<>"M", mas n√£o est√° no c√≥digo

PRIORIDADE ALTA (Pode causar erros):

4. ‚ùå VALIDA√á√ïES INCOMPLETAS
   - N√£o valida se Bico foi selecionado (obrigat√≥rio)
   - N√£o valida se Destino foi selecionado (obrigat√≥rio)
   - N√£o valida se Insumo foi selecionado (obrigat√≥rio)

5. ‚ùå CAMPOS NA UI SEM CONEX√ÉO
   - "Od√¥metro Atual" existe mas n√£o tem ngModel
   - "Hor√≠metro Atual" existe mas n√£o tem ngModel
   - "Hora Abastecimento" existe mas n√£o est√° conectado

PRIORIDADE M√âDIA (Melhoria recomendada):

6. ‚ö†Ô∏è CONSULTA DE √öLTIMO N√öMERO N√ÉO IMPLEMENTADA
   - Doc recomenda usar ConsultaUltimoNumeroBico para preencher No.Bomba Inicial
   - Atualmente √© campo manual

7. ‚ö†Ô∏è IdEQUIPAMENTO S√ì ENVIADO EM CASOS ESPEC√çFICOS
   - Atualmente s√≥ envia quando destinoTipo='M'
   - Verificar com backend se sempre deve enviar


====================================================================
PARTE 8 - CHECKLIST DE IMPLEMENTA√á√ÉO (O QUE FAZER)
====================================================================

============================
FASE 1 - CORRE√á√ïES CR√çTICAS
============================

[ ] 1.1. IMPLEMENTAR EDI√á√ÉO REAL
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts

    Passos:
    - No ngOnInit(), ler queryParams ou route state para pegar abastecimentoId
    - Se houver ID, chamar API para buscar dados (criar m√©todo se necess√°rio)
    - Preencher todos os campos do formul√°rio com valores retornados
    - Diferenciar novo vs edi√ß√£o no m√©todo confirmar()
    - Se backend exige, enviar ID do abastecimento no payload de edi√ß√£o

[ ] 1.2. ADICIONAR CAMPOS FALTANTES NO PAYLOAD
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()

    Adicionar ao objeto params:
    - TipoPrevAbast: this.tipoPrevAbast (se selecionado)
    - AplicacaoPrevId: this.aplicacaoSelecionada (se selecionado)
    - IdEtapa: this.etapaSelecionada (se selecionado)
    - IdTanqueDestino: l√≥gica baseada em destinoTipo (se destinoTipo<>'M', enviar o destino)

[ ] 1.3. IMPLEMENTAR IdTanqueDestino
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()

    L√≥gica:
    - Descobrir o destinoObj (j√° existe no c√≥digo)
    - Se destinoTipo<>'M' (ou seja, N√ÉO √© equipamento):
      -> Enviar IdTanqueDestino com o valor de destinoSelecionado
    - Testar com backend para confirmar o nome correto do campo

[ ] 1.4. ADICIONAR VALIDA√á√ïES OBRIGAT√ìRIAS
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()

    Adicionar valida√ß√µes:
    - if (!this.bicoSelecionado) { toast('Bico obrigat√≥rio'); return; }
    - if (!this.destinoSelecionado) { toast('Destino obrigat√≥rio'); return; }
    - if (!this.insumoSelecionado) { toast('Insumo obrigat√≥rio'); return; }

============================
FASE 2 - AJUSTES IMPORTANTES
============================

[ ] 2.1. CONECTAR OU REMOVER "HORA ABASTECIMENTO"
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.html

    Op√ß√£o A: Se hora deve ser enviada separadamente
    - Criar vari√°vel: horaAbastecimento
    - Conectar ngModel no input type="time"
    - Combinar com data ao montar DataAbastecimento (ex: 2025-12-24T14:30:00)

    Op√ß√£o B: Se hora j√° est√° na data
    - Remover o campo da UI

[ ] 2.2. CONECTAR OU REMOVER "OD√îMETRO/HOR√çMETRO ATUAL"
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.html

    Op√ß√£o A: Se s√£o necess√°rios
    - Criar vari√°veis: odometroAtual, horimetroAtual
    - Conectar ngModel
    - Descobrir nome dos campos no backend e adicionar ao payload

    Op√ß√£o B: Se n√£o s√£o necess√°rios
    - Remover os campos da UI (manter s√≥ Od√¥metro e Hor√≠metro de abastecimento)

[ ] 2.3. IMPLEMENTAR ConsultaUltimoNumeroBico
    Arquivo: src/app/services/abastecimento.service.ts

    - Criar m√©todo: consultarUltimoNumeroBico(bombaId, bicoId)
      -> GET /api/frotas/Abastecimentos/ConsultaUltimoNumeroBico
      -> Retorna: { numeracao, abastecimentoData, abastecimentoCod, abastecimentoId }

    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts

    - Quando bomba e bico forem selecionados, chamar a API
    - Auto-preencher this.numBombaInicial com o resultado + 1 (ou conforme regra de neg√≥cio)

[ ] 2.4. REVISAR L√ìGICA DE IdEquipamento
    Arquivo: src/app/page/abastecimento-proprio-edicao/abastecimento-proprio-edicao.page.ts
    M√©todo: confirmar()

    - Verificar com backend: IdEquipamento deve SEMPRE ser enviado ou s√≥ quando destino √© equipamento?
    - Atualmente s√≥ envia se destinoTipo='M' ou destinoSelecionado='01'
    - Ajustar conforme retorno do backend

============================
FASE 3 - REFINAMENTOS
============================

[ ] 3.1. MELHORAR MENSAGENS DE ERRO
    - Tornar toasts mais espec√≠ficos
    - Adicionar √≠cones diferentes (warning vs danger)

[ ] 3.2. ADICIONAR LOADING STATES
    - Mostrar spinner enquanto carrega combos
    - Desabilitar bot√£o CONFIRMAR durante grava√ß√£o

[ ] 3.3. CONFIRMA√á√ÉO AO SAIR
    - Se formul√°rio foi alterado e usu√°rio tenta sair, mostrar confirma√ß√£o

[ ] 3.4. TRATAMENTO DE ERROS DA API
    - Melhorar mensagens quando API retorna erro
    - Mostrar detalhes do erro (se dispon√≠vel)

[ ] 3.5. CRIAR M√âTODO PARA BUSCAR ABASTECIMENTO POR ID
    Arquivo: src/app/services/abastecimento.service.ts

    - Se n√£o existir m√©todo espec√≠fico, criar:
      consultarAbastecimentoProprioPorId(abastecimentoId: string)
    - Ou ajustar consultarAbastecimentoProprio para aceitar ID como filtro


====================================================================
PARTE 9 - COMPARA√á√ÉO: ABASTECIMENTO PR√ìPRIO vs ABASTECIMENTO POSTO
====================================================================

| Aspecto                    | Abastecimento Pr√≥prio (Tp=0) | Abastecimento Posto (Tp=1) |
|----------------------------|------------------------------|----------------------------|
| Origem do combust√≠vel      | Bomba/Tanque da empresa      | Posto externo (Fornecedor) |
| Campos espec√≠ficos         | Bomba, Bico, Destino         | Fornecedor, Voucher        |
| Estoque                    | Comboio da empresa           | N/A                        |
| Aplica√ß√£o/Troca-Reposi√ß√£o  | SIM (campos novos)           | N√ÉO                        |
| Controle num√©rico          | NumBomba Inicial/Final       | N√∫mero Controle Posto      |
| Valor/Total                | N√ÉO (quantidade apenas)      | TotalAbastecimentoPosto    |
| Frentista                  | SIM (colaborador interno)    | N√ÉO (ou opcional)          |
| Empresa/Centro Despesa     | N√ÉO obrigat√≥rio              | SIM obrigat√≥rio            |
| Bloco                      | SIM (opcional)               | SIM (obrigat√≥rio)          |

OBSERVA√á√ÉO:
O Abastecimento Pr√≥prio √© mais focado no controle operacional (bomba, bico, destino, aplica√ß√£o),
enquanto o Abastecimento em Postos √© mais focado no controle financeiro (empresa, centro despesa, valor).


====================================================================
PARTE 10 - PR√ìXIMOS PASSOS RECOMENDADOS
====================================================================

SUGEST√ÉO DE ORDEM DE IMPLEMENTA√á√ÉO:

1¬∫) CORRIGIR PAYLOAD (mais r√°pido e cr√≠tico)
    - Adicionar TipoPrevAbast ao payload
    - Adicionar AplicacaoPrevId ao payload
    - Adicionar IdEtapa ao payload
    - Implementar l√≥gica de IdTanqueDestino
    Tempo estimado: 30-60 minutos

2¬∫) ADICIONAR VALIDA√á√ïES
    - Validar campos obrigat√≥rios antes de enviar
    Tempo estimado: 15-30 minutos

3¬∫) IMPLEMENTAR EDI√á√ÉO
    - Ler ID da rota
    - Buscar dados na API
    - Preencher formul√°rio
    - Diferenciar novo vs edi√ß√£o
    Tempo estimado: 2-3 horas

4¬∫) AJUSTAR CAMPOS "ATUAL" E "HORA"
    - Decidir se mant√©m ou remove
    - Implementar conforme decis√£o
    Tempo estimado: 30-60 minutos

5¬∫) IMPLEMENTAR ConsultaUltimoNumeroBico
    - Criar m√©todo no servi√ßo
    - Auto-preencher No.Bomba Inicial
    Tempo estimado: 1 hora

6¬∫) REFINAMENTOS
    - Melhorar UX, mensagens, loading
    Tempo estimado: 2-4 horas

TOTAL ESTIMADO: 6-12 horas de desenvolvimento


====================================================================
CONSIDERA√á√ïES FINAIS
====================================================================

PONTOS POSITIVOS:
‚úÖ Estrutura bem organizada (3 telas separadas)
‚úÖ Integra√ß√£o com APIs bem feita
‚úÖ L√≥gica de depend√™ncias entre campos funcionando
‚úÖ Service centralizado e bem estruturado
‚úÖ Navega√ß√£o entre telas OK
‚úÖ Maioria dos campos implementados

PONTOS DE ATEN√á√ÉO:
‚ö†Ô∏è Tela diz "Edi√ß√£o" mas n√£o edita (confunde usu√°rio)
‚ö†Ô∏è Campos selecion√°veis mas n√£o enviados (perda de dados)
‚ö†Ô∏è Faltam valida√ß√µes importantes
‚ö†Ô∏è Campos na UI sem fun√ß√£o (Od√¥metro/Hor√≠metro Atual)

RISCO:
- Se usu√°rio tenta editar um abastecimento existente e grava, pode criar duplicata
- Se usu√°rio seleciona Aplica√ß√£o/Troca-Reposi√ß√£o e grava, esses dados s√£o perdidos

RECOMENDA√á√ÉO:
Priorizar corre√ß√£o do payload e valida√ß√µes (itens 1 e 2 acima) antes de outras melhorias,
pois impactam na integridade dos dados gravados.


====================================================================
FIM DO DOCUMENTO
====================================================================

√öltima atualiza√ß√£o: 24/12/2025
Respons√°vel: An√°lise automatizada do c√≥digo vs documenta√ß√£o
